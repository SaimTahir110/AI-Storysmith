<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryInk</title>
    <!-- Primary font for Latin-based languages -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font for Urdu and other Arabic-script languages -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Social Media Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Nastaliq Urdu', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container {
            max-width: 960px;
            padding: 1rem;
        }
        .header-card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 1.5rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }
        .card {
            background-color: #2d3748;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .gradient-text {
            background: linear-gradient(45deg, #38bdf8, #818cf8, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .button-gradient {
            background-image: linear-gradient(to right, var(--color-from), var(--color-to));
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            font-weight: 700;
            color: white;
            border-radius: 9999px;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .button-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        .button-gradient:disabled {
            background-image: linear-gradient(to right, #4a5568, #2d3748);
            color: #718096;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        /* Specific button colors */
        .btn-prompt {
            --color-from: #3b82f6;
            --color-to: #2563eb;
        }
        .btn-story {
            --color-from: #8b5cf6;
            --color-to: #6d28d9;
        }
        .btn-suggest {
            --color-from: #d946ef;
            --color-to: #c026d3;
        }
        .btn-save {
            --color-from: #10b981;
            --color-to: #059669;
        }
        .btn-audio {
            --color-from: #38bdf8;
            --color-to: #0ea5e9;
        }
        .btn-auth {
            --color-from: #f59e0b;
            --color-to: #d97706;
        }
        .btn-outline {
            --color-from: #f43f5e;
            --color-to: #e11d48;
        }
        .btn-refine {
            --color-from: #f59e0b;
            --color-to: #d97706;
        }
        .social-icon {
            font-size: 1.5rem;
            color: #93c5fd;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .social-icon:hover {
            color: #3b82f6;
            transform: scale(1.1);
        }
        .footer-link {
            font-size: 0.875rem;
            font-weight: 600;
            color: #93c5fd;
            transition: color 0.2s ease-in-out;
        }
        .footer-link:hover {
            color: #3b82f6;
        }
        textarea {
            resize: none;
            scrollbar-width: none;
        }
        textarea::-webkit-scrollbar {
            display: none;
        }
        .output-text {
            font-size: 1.1rem;
            line-height: 1.8;
            font-weight: 700;
        }
        /* Fade-in animation for outputs */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* New fade-in-up animation for suggestions */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .suggestion-item {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        /* Highlighting for audio playback */
        .highlighted-word {
            background-color: #4a5568;
            border-radius: 0.25rem;
            padding: 0.1rem 0.25rem;
            transition: background-color 0.1s ease-in-out;
        }
        /* Modern audio button styles */
        .audio-icon-container {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            background-color: #38bdf8;
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.4);
            transition: all 0.3s ease-in-out;
        }
        .audio-icon-container:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(56, 189, 248, 0.6);
        }
        .audio-icon-container svg {
            width: 1.5rem;
            height: 1.5rem;
            color: #1a202c;
        }
        .audio-icon-container .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Active category button styling */
        .category-button.active {
            background: linear-gradient(45deg, #3b82f6, #60a5fa);
            color: white;
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
            transform: translateY(-3px) scale(1.05);
        }
        .category-button {
            border: 2px solid #4a5568;
            background-color: #2d3748;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            white-space: nowrap;
            position: relative;
            z-index: 10;
            animation: categoryFadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        .category-button:hover:not(.active) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            border-color: #38bdf8;
            background-color: #374151;
        }
        @keyframes categoryFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* New CSS for the category loading overlay */
        .category-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 32, 44, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 1.5rem;
            z-index: 20;
            transition: opacity 0.3s ease-in-out;
        }
        /* New loading screen animations */
        .loading-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #93c5fd;
            animation: pulse-title 1.5s infinite;
        }
        @keyframes pulse-title {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .loading-icon-container {
            display: flex;
            gap: 1.5rem;
            animation: bounce-icons 2s infinite ease-in-out;
            transform-origin: bottom;
        }
        @keyframes bounce-icons {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        /* New spinner for the category loading overlay */
        .category-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid #4a5568;
            border-top-color: #60a5fa;
            animation: spin 1s linear infinite;
        }
        /* Modern header navigation styles */
        .modern-nav {
            background-color: rgba(26, 32, 44, 0.7); /* Semi-transparent background */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(74, 85, 104, 0.4);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother easing */
            z-index: 50;
            padding: 1rem 0;
        }
        .header-hidden {
            transform: translateY(-100%);
        }
        .nav-link {
            color: #a0aec0;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }
        /* New classic hover effect */
        .nav-link:hover {
            color: #ffffff;
            background-color: transparent;
        }
        .nav-link:hover::after, .nav-link.active::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 0;
            width: 80%;
            height: 2px;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #38bdf8, #818cf8, #a78bfa);
            border-radius: 2px;
        }
        .nav-link.active {
            color: white;
            background-color: transparent;
            font-weight: 700;
        }
        /* Classic divider line for the logo section */
        .logo-divider {
            height: 20px;
            width: 1px;
            background-color: #4a5568;
            margin: 0 1.5rem;
        }
        /* Content page styles */
        .page {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .page-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            min-height: 400px;
        }
        .hidden {
            display: none;
        }
        /* New styles for the scrollable category area */
        .category-list-container {
            -webkit-overflow-scrolling: touch;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            overflow-x: auto;
            scrollbar-width: none;
        }
        .category-list-container::-webkit-scrollbar {
            display: none;
        }
        /* New styles for saved stories cards */
        .story-card {
            background-color: #2d3748;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .story-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .story-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #4a5568;
        }
        .story-card-content {
            max-height: 200px;
            overflow: hidden;
            position: relative;
        }
        .story-card-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to bottom, transparent, #2d3748);
        }
        .story-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .story-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        /* New styles for custom dropdowns */
        .styled-select-wrapper {
            position: relative;
            width: 100%;
            animation: fadeInUp 0.5s ease-out forwards;
        }
        .styled-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            background-color: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 0.75rem;
            color: #e2e8f0;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2.5' stroke='%239ca3af' %3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.2em;
        }
        .styled-select:hover {
            border-color: #38bdf8;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .styled-select:focus {
            outline: none;
            border-color: #38bdf8;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.4);
        }
        /* New Modern Footer styles */
        .modern-footer {
            background-color: rgba(26, 32, 44, 0.7); /* Semi-transparent background */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(74, 85, 104, 0.4);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.5);
        }
        .footer-link:hover {
            color: #60a5fa;
            text-shadow: 0 0 8px rgba(96, 165, 250, 0.5);
        }
        .social-icon:hover {
            color: #60a5fa;
            transform: scale(1.1) translateY(-2px);
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.6);
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen">
    <!-- Modern Navigation Header -->
    <header class="w-full modern-nav fixed top-0 py-1">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 mr-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">SI</div>
                <h1 class="text-lg md:text-xl font-bold gradient-text">StoryInk</h1>
                <!-- Classic divider line -->
                <div class="logo-divider hidden md:block"></div>
            </div>
            <nav class="mt-4 md:mt-0">
                <ul class="flex space-x-2 md:space-x-4">
                    <li><a href="#home-page" class="nav-link active" id="nav-home">Home</a></li>
                    <li><a href="#about-us-page" class="nav-link" id="nav-about">About Us</a></li>
                    <li><a href="#blog-page" class="nav-link" id="nav-blog">Blog</a></li>
                    <li><a href="#contact-us-page" class="nav-link" id="nav-contact">Contact Us</a></li>
                    <li id="myStoriesNav" class="hidden"><a href="#my-stories-page" class="nav-link" id="nav-my-stories"><i class="fas fa-bookmark"></i> <span class="hidden md:inline">My Stories</span></a></li>
                    <li id="loginNav"><a href="#login-page" class="nav-link" id="nav-login">Login</a></li>
                    <li id="registerNav" class="hidden"><a href="#register-page" class="nav-link" id="nav-register">Register</a></li>
                    <li id="logoutNav" class="hidden"><button id="logoutBtn" class="nav-link">Logout</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Pages -->
    <div class="container mx-auto mt-16 md:mt-20 p-4 md:p-8 space-y-8">
        <!-- Home Page Content (Existing Content) -->
        <div id="home-page" class="page">
            <header class="header-card text-center p-8 mb-8">
                <p class="mt-4 text-lg text-gray-300">Your creative companion. Generate stories in any language.</p>
                
                <!-- Category Navigation -->
                <nav class="mt-12">
                    <div class="category-list-container">
                        <ul class="flex justify-start sm:justify-center flex-nowrap space-x-4 px-2 pb-2 text-gray-300 text-sm font-semibold">
                            <li id="generalBtn" class="category-button active px-4 py-2 rounded-full transition-colors cursor-pointer" data-category="general">General Stories</li>
                            <li id="childrensStoriesBtn" class="category-button px-4 py-2 rounded-full transition-colors cursor-pointer" data-category="childrensStories">Children's Stories</li>
                            <li id="poemsBtn" class="category-button px-4 py-2 rounded-full transition-colors cursor-pointer" data-category="poems">Poems</li>
                            <li id="riddlesBtn" class="category-button px-4 py-2 rounded-full transition-colors cursor-pointer" data-category="riddles">Riddles</li>
                            <li id="jokesBtn" class="category-button px-4 py-2 rounded-full transition-colors cursor-pointer" data-category="jokes">Jokes</li>
                            <li id="poetryBtn" class="category-button px-4 py-2 rounded-full transition-colors cursor-pointer" data-category="poetry">Poetry</li>
                        </ul>
                    </div>
                </nav>
            </header>

            <!-- Main Content Card -->
            <main class="card p-8 space-y-8 relative">
                <!-- Category Loading Overlay - New and improved -->
                <div id="categoryLoadingOverlay" class="category-loading-overlay hidden">
                    <div class="category-spinner"></div>
                </div>
                <section class="space-y-4">
                    <label for="keywords" class="block text-lg font-semibold text-gray-300">Enter your keywords</label>
                    <textarea id="keywords" rows="3" class="w-full p-4 rounded-xl bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors placeholder:text-gray-400" placeholder="e.g., 'a magical lake, a small deer'"></textarea>
                    
                    <!-- New controls for Language, Length, Audience, Format, and Genre -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4">
                        <div>
                            <label for="storyLanguage" class="block text-sm font-medium text-gray-400 mb-1">Language</label>
                            <div class="styled-select-wrapper">
                                <select id="storyLanguage" class="styled-select">
                                    <option value="en-US">English</option>
                                    <option value="ur-PK">Urdu</option>
                                    <option value="ar-EG">Arabic</option>
                                    <option value="de-DE">German</option>
                                    <option value="es-US">Spanish</option>
                                    <option value="fr-FR">French</option>
                                    <option value="hi-IN">Hindi</option>
                                    <option value="ja-JP">Japanese</option>
                                    <option value="ko-KR">Korean</option>
                                    <option value="pt-BR">Portuguese</option>
                                    <option value="ru-RU">Russian</option>
                                    <option value="zh-CN">Chinese</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="storyLength" class="block text-sm font-medium text-gray-400 mb-1">Length</label>
                            <div class="styled-select-wrapper">
                                <select id="storyLength" class="styled-select">
                                    <option value="short">Short (approx. 300 words)</option>
                                    <option value="medium">Medium (approx. 600 words)</option>
                                    <option value="long">Long (approx. 1000 words)</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="storyAudience" class="block text-sm font-medium text-gray-400 mb-1">Audience</label>
                            <div class="styled-select-wrapper">
                                <select id="storyAudience" class="styled-select">
                                    <option value="general">General</option>
                                    <option value="children">Children</option>
                                    <option value="teens">Teens</option>
                                    <option value="adults">Adults</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="storyFormat" class="block text-sm font-medium text-gray-400 mb-1">Format</label>
                            <div class="styled-select-wrapper">
                                <select id="storyFormat" class="styled-select">
                                    <option value="prose">Prose</option>
                                    <option value="short story">Short Story</option>
                                    <option value="riddle">Riddle</option>
                                    <option value="joke">Joke</option>
                                    <option value="poetry">Poetry</option>
                                    <option value="poem">Poem</option>
                                    <option value="script">Script</option>
                                    <option value="flash fiction">Flash Fiction</option>
                                    <option value="novella">Novella</option>
                                    <option value="screenplay">Screenplay</option>
                                    <option value="letter">Letter</option>
                                    <option value="journal entry">Journal Entry</option>
                                    <option value="article">Article</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="storyGenre" class="block text-sm font-medium text-gray-400 mb-1">Genre</label>
                            <div class="styled-select-wrapper">
                                <select id="storyGenre" class="styled-select">
                                    <option value="fantasy">Fantasy</option>
                                    <option value="sci-fi">Sci-Fi</option>
                                    <option value="mystery">Mystery</option>
                                    <option value="romance">Romance</option>
                                    <option value="horror">Horror</option>
                                    <option value="comedy">Comedy</option>
                                    <option value="thriller">Thriller</option>
                                    <option value="historical fiction">Historical Fiction</option>
                                    <option value="dystopian">Dystopian</option>
                                    <option value="adventure">Adventure</option>
                                    <option value="young adult">Young Adult</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button id="suggestIdeasBtn" class="w-full button-gradient btn-suggest mt-4">
                        ✨Suggest Ideas✨
                    </button>
                </section>
                
                <section id="suggestionOutput" class="space-y-4 hidden">
                    <!-- Suggestions will be added here -->
                </section>

                <section class="space-y-4">
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <button id="generatePromptBtn" class="flex-1 w-full sm:w-auto button-gradient btn-prompt">
                            Generate Prompt
                        </button>
                        <button id="generateStoryBtn" class="flex-1 w-full sm:w-auto button-gradient btn-story">
                            Write Story
                        </button>
                    </div>
                </section>

                <section id="outputSection" class="space-y-8 mt-8">
                    <div id="promptOutput" class="min-h-[100px] p-6 rounded-xl bg-gray-700 border border-gray-600 shadow-inner">
                        <p id="promptPlaceholder" class="text-gray-400 italic">Your story prompt will appear here...</p>
                    </div>
                    
                    <!-- Story Output with a dedicated loading message area -->
                    <div id="storyOutput" class="relative min-h-[200px] p-6 rounded-xl bg-gray-700 border border-gray-600 shadow-inner">
                        <p id="storyPlaceholder" class="text-gray-400 italic">Your complete story will appear here...</p>
                        <!-- New and improved loading state -->
                        <div id="storyLoadingOverlay" class="absolute inset-0 flex items-center justify-center p-4 bg-gray-700 bg-opacity-80 rounded-xl hidden">
                            <div class="text-center text-gray-300">
                                <div class="category-spinner mx-auto mb-4"></div>
                                <p class="text-lg font-semibold">Crafting your story...</p>
                                <p class="text-sm">This may take a moment depending on the length.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Separate buttons for save and audio playback -->
                    <div id="storyActions" class="flex flex-wrap space-x-2 space-y-2 sm:space-y-0 justify-end mt-4 hidden">
                         <button id="refineStoryBtn" class="button-gradient btn-refine">
                            ✨Refine Story✨
                        </button>
                        <button id="saveStoryBtn" class="button-gradient btn-save">
                            Save Story
                        </button>
                        <button id="audioControlBtn" class="button-gradient btn-audio flex items-center justify-center">
                            <span id="audioButtonText" class="mr-2">Download Audio (MP3)</span>
                            <svg id="downloadIcon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 17.25l-4.5-4.5h3v-6h3v6h3zM12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18zm0-2a7 7 0 1 1 0-14 7 7 0 0 1 0 14z"/>
                            </svg>
                            <svg id="audioLoadingSpinner" class="animate-spin w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                            </svg>
                        </button>
                    </div>
                </section>
            </main>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page hidden">
            <div class="page-content text-center">
                <h2 class="text-3xl font-bold gradient-text mb-4">Login</h2>
                <form id="loginForm" class="space-y-4 max-w-sm mx-auto">
                    <input type="email" id="loginEmail" placeholder="Email" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="loginPassword" placeholder="Password" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p id="loginMessage" class="text-sm"></p>
                    <button type="submit" class="w-full button-gradient btn-auth">Login</button>
                    <p class="text-gray-400">Don't have an account? <a href="#register-page" class="text-blue-400 hover:underline">Register here</a></p>
                </form>
            </div>
        </div>

        <!-- Registration Page -->
        <div id="register-page" class="page hidden">
            <div class="page-content text-center">
                <h2 class="text-3xl font-bold gradient-text mb-4">Register</h2>
                <form id="registerForm" class="space-y-4 max-w-sm mx-auto">
                    <input type="email" id="registerEmail" placeholder="Email" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="registerPassword" placeholder="Password" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p id="registerMessage" class="text-sm"></p>
                    <button type="submit" class="w-full button-gradient btn-auth">Register</button>
                    <p class="text-gray-400">Already have an account? <a href="#login-page" class="text-blue-400 hover:underline">Login here</a></p>
                </form>
            </div>
        </div>
        
        <!-- My Stories Page -->
        <div id="my-stories-page" class="page hidden">
            <div class="page-content">
                <h2 class="text-3xl font-bold gradient-text mb-4">My Stories</h2>
                <p class="text-gray-400 mb-6">Your unique user ID: <span id="userIdDisplay" class="font-bold text-blue-300">guest-1234</span></p>
                <div id="storiesList" class="story-grid">
                    <p class="text-gray-400 italic text-center col-span-full" id="storiesPlaceholder">You have no stories saved yet.</p>
                    <!-- Saved stories will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- About Us Page -->
        <div id="about-us-page" class="page hidden">
            <div class="page-content">
                <h2 class="text-3xl font-bold gradient-text mb-4">About StoryInk</h2>
                <p class="text-gray-300 mb-4">StoryInk is more than just a tool; it's a creative companion designed to help you unlock your imagination. We believe that everyone has a story to tell, and our mission is to make the process of bringing those ideas to life as effortless and inspiring as possible.</p>

                <h2 class="text-3xl font-bold gradient-text mb-4 mt-8">Our Mission</h2>
                <p class="text-gray-300 mb-4">Our primary mission is to break down the barriers to creative expression. We understand that writer's block, a blank page, or a lack of inspiration can be daunting. By leveraging cutting-edge AI technology, we provide an intuitive space where you can generate prompts, explore new genres, and craft compelling stories in any language.</p>

                <h2 class="text-3xl font-bold gradient-text mb-4 mt-8">The Technology Behind the Magic</h2>
                <p class="text-gray-300 mb-4">Our AI models are built on a foundation of extensive literary and narrative data, allowing them to understand context, tone, and structure. This advanced technology enables us to transform your keywords and ideas into coherent and engaging stories.</p>

                <h2 class="text-3xl font-bold gradient-text mb-4 mt-8">Who We Are</h2>
                <p class="text-gray-300 mb-4">We are a passionate team of developers, writers, and innovators dedicated to the art of storytelling. Our shared goal is to build a platform that not only simplifies the writing process but also ignites a love for creation.</p>

                <h2 class="text-3xl font-bold gradient-text mb-4 mt-8">Join the Journey</h2>
                <p class="text-gray-300">We invite you to start your creative journey with us. Whether you're looking to pen a short story, craft a poem, or simply find a spark of inspiration, StoryInk is here to help you turn your ideas into reality.</p>
            </div>
        </div>

        <!-- Blog Page -->
        <div id="blog-page" class="page hidden">
            <div class="page-content">
                <h2 class="text-3xl font-bold gradient-text mb-4">Our Blog</h2>
                <div class="space-y-8">
                    <article class="card p-6">
                        <h3 class="text-xl font-bold text-gray-200 mb-2">Tips for Using AI to Spark Creativity</h3>
                        <p class="text-gray-400 text-sm mb-4">Published on September 15, 2025</p>
                        <p class="text-gray-300">Discover how to use AI tools like StoryInk to brainstorm new ideas, develop characters, and structure your plots. We share our top five tips to help you get the most out of your creative companion.</p>
                    </article>
                    <article class="card p-6">
                        <h3 class="text-xl font-bold text-gray-200 mb-2">The Future of AI in Storytelling</h3>
                        <p class="text-gray-400 text-sm mb-4">Published on September 10, 2025</p>
                        <p class="text-gray-300">Explore the exciting future of AI in the literary world. From collaborative writing to creating entirely new genres, we discuss the ethical considerations and creative opportunities that lie ahead.</p>
                    </article>
                </div>
            </div>
        </div>

        <!-- Contact Us Page -->
        <div id="contact-us-page" class="page hidden">
            <div class="page-content">
                <h2 class="text-3xl font-bold gradient-text mb-4">Get in Touch</h2>
                <p class="text-gray-300 mb-6" id="contact-message-status">We'd love to hear from you! Whether you have feedback, a question, or a feature request, please fill out the form below and we'll get back to you as soon as possible.</p>
                <form id="contactForm" class="space-y-4">
                    <div>
                        <label for="contactEmail" class="block text-sm font-medium text-gray-400 mb-1">Your email:</label>
                        <input type="email" id="contactEmail" name="email" class="w-full p-2 rounded-lg bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="contactMessage" class="block text-sm font-medium text-gray-400 mb-1">Your message:</label>
                        <textarea id="contactMessage" name="message" rows="5" class="w-full p-2 rounded-lg bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="w-full button-gradient btn-prompt mt-4">Send</button>
                </form>
            </div>
        </div>

        <!-- Privacy Policy Page -->
        <div id="privacy-policy-page" class="page hidden">
            <div class="page-content">
                <h2 class="text-3xl font-bold gradient-text mb-4">Privacy Policy</h2>
                <p class="text-gray-300 mb-4">Your privacy is important to us. This policy outlines how we collect, use, and protect your information when you use StoryInk. We are committed to ensuring the security of your data.</p>
                <h3 class="text-2xl font-bold text-gray-200 mt-8 mb-2">Information We Collect</h3>
                <p class="text-gray-300 mb-4">We collect information that you voluntarily provide when you use our services, such as the keywords and language you enter to generate stories. This data is used solely to provide and improve our services to you.</p>
            </div>
        </div>

        <!-- Terms of Service Page -->
        <div id="terms-of-service-page" class="page hidden">
            <div class="page-content">
                <h2 class="text-3xl font-bold gradient-text mb-4">Terms of Service</h2>
                <p class="text-gray-300 mb-4">Welcome to StoryInk! These terms and conditions outline the rules and regulations for the use of our website and services.</p>
                <h3 class="text-2xl font-bold text-gray-200 mt-8 mb-2">1. Acceptance of Terms</h3>
                <p class="text-gray-300 mb-4">By accessing this website, you agree to be bound by these Terms of Service. If you disagree with any part of the terms, you may not access the service.</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="w-full modern-footer text-gray-400 py-6 mt-auto">
        <div class="container mx-auto text-center flex flex-col sm:flex-row items-center justify-between px-4 sm:px-0">
            <p class="text-sm">&copy; 2025 StoryInk. All Rights Reserved.</p>
            <div class="flex items-center space-x-6 mt-4 sm:mt-0">
                <a href="#privacy-policy-page" class="footer-link">Privacy Policy</a>
                <a href="#terms-of-service-page" class="footer-link">Terms of Service</a>
                <div class="flex space-x-4">
                    <a href="#" class="social-icon"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-icon"><i class="fab fa-facebook"></i></a>
                    <a href="#" class="social-icon"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </footer>

    
    <!-- Firebase SDK Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Globals & Initializations ---
        let app;
        let db;
        let auth;
        let userId = null;
        let currentStoryText = "";
        let appId = 'default-app-id';
        
        const WORD_COUNTS = {
            'short': 300,
            'medium': 600,
            'long': 1000
        };

        // UI elements
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const loginNav = document.getElementById('loginNav');
        const registerNav = document.getElementById('registerNav');
        const myStoriesNav = document.getElementById('myStoriesNav');
        const logoutNav = document.getElementById('logoutNav');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const storyOutput = document.getElementById('storyOutput');
        const storyPlaceholder = document.getElementById('storyPlaceholder');
        const storyLoadingOverlay = document.getElementById('storyLoadingOverlay');
        const keywordsInput = document.getElementById('keywords');
        const generatePromptBtn = document.getElementById('generatePromptBtn');
        const generateStoryBtn = document.getElementById('generateStoryBtn');
        const suggestIdeasBtn = document.getElementById('suggestIdeasBtn');
        const promptOutput = document.getElementById('promptOutput');
        const promptPlaceholder = document.getElementById('promptPlaceholder');
        const suggestionOutput = document.getElementById('suggestionOutput');
        const saveStoryBtn = document.getElementById('saveStoryBtn');
        const refineStoryBtn = document.getElementById('refineStoryBtn');
        const storiesList = document.getElementById('storiesList');
        const storiesPlaceholder = document.getElementById('storiesPlaceholder');
        const storyActions = document.getElementById('storyActions');
        const audioControlBtn = document.getElementById('audioControlBtn');
        const audioButtonText = document.getElementById('audioButtonText');
        const downloadIcon = document.getElementById('downloadIcon');
        const audioLoadingSpinner = document.getElementById('audioLoadingSpinner');
        const header = document.querySelector('header.modern-nav');
        let lastScrollTop = 0;
        
        // Authentication and Firestore Setup
        const initializeFirebase = async () => {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // This listener runs every time the authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is authenticated
                        userId = user.uid;
                        console.log("User is authenticated:", userId);
                        updateAuthUI(true);
                        // Only attach the Firestore listener when we have a valid user
                        listenForStories();
                    } else {
                        // User is not authenticated
                        userId = null;
                        console.log("User is not authenticated. Signing in anonymously...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                        } catch (error) {
                            console.error("Authentication failed:", error);
                        }
                        updateAuthUI(false);
                        // Do not listen to stories if no user is signed in
                        storiesList.innerHTML = '<p class="text-gray-400 italic text-center col-span-full" id="storiesPlaceholder">Sign in to save and view your stories.</p>';
                    }
                });
            } else {
                console.error("Firebase config is missing.");
                updateAuthUI(false);
            }
        };

        const updateAuthUI = (isAuthenticated) => {
            if (isAuthenticated) {
                loginNav.classList.add('hidden');
                registerNav.classList.add('hidden');
                myStoriesNav.classList.remove('hidden');
                logoutNav.classList.remove('hidden');
                userIdDisplay.textContent = auth.currentUser.uid;
            } else {
                loginNav.classList.remove('hidden');
                registerNav.classList.remove('hidden');
                myStoriesNav.classList.add('hidden');
                logoutNav.classList.add('hidden');
                userIdDisplay.textContent = 'Sign in to save stories.';
            }
        };

        // Story management with Firestore
        const getStoriesCollectionRef = () => {
            // Ensure userId is not null before creating the path
            if (!userId) {
                console.error("Cannot get stories collection: userId is null.");
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/my-stories`);
        };

        const listenForStories = () => {
            if (!db || !userId) return;
            const storiesRef = getStoriesCollectionRef();
            if (!storiesRef) {
                return;
            }
            onSnapshot(storiesRef, (snapshot) => {
                const stories = [];
                snapshot.forEach(doc => {
                    stories.push({ id: doc.id, ...doc.data() });
                });
                renderStories(stories);
            }, (error) => {
                console.error("Error listening to stories:", error);
            });
        };
        
        const renderStories = (stories) => {
            storiesList.innerHTML = '';
            if (stories.length === 0) {
                storiesList.innerHTML = '<p class="text-gray-400 italic text-center col-span-full" id="storiesPlaceholder">You have no stories saved yet.</p>';
                return;
            }
            
            stories.forEach(story => {
                const formattedDate = story.timestamp?.seconds ? new Date(story.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                const storyElement = document.createElement('div');
                storyElement.className = 'story-card';
                storyElement.innerHTML = `
                    <div class="story-card-header">
                        <span class="text-sm text-gray-400">${formattedDate}</span>
                        <span class="text-xs px-2 py-1 rounded-full bg-blue-900 text-blue-200">${story.category || 'General'}</span>
                    </div>
                    <div class="story-card-content">
                        <p class="output-text">${story.text.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="story-card-actions">
                        <button class="button-gradient btn-prompt text-xs p-2 copy-story-btn">Copy</button>
                        <button class="button-gradient btn-story text-xs p-2 download-mp3-btn" data-text="${escapeHtml(story.text)}">Audio</button>
                        <button class="button-gradient btn-save text-xs p-2 delete-story-btn">Delete</button>
                    </div>
                `;
                storiesList.appendChild(storyElement);
                
                storyElement.querySelector('.copy-story-btn').addEventListener('click', () => {
                    copyText(story.text);
                });
                storyElement.querySelector('.download-mp3-btn').addEventListener('click', async (event) => {
                    const textToConvert = event.target.dataset.text;
                    if (textToConvert) {
                        try {
                            const audioBlob = await convertTextToAudio(textToConvert);
                            downloadAudio(audioBlob, `story_${Date.now()}.mp3`);
                        } catch (error) {
                            console.error("Failed to download MP3:", error);
                            showPromptMessage(`Failed to convert audio: ${error.message}`, '#storyOutput');
                        }
                    }
                });
                storyElement.querySelector('.delete-story-btn').addEventListener('click', () => {
                    deleteStory(story.id);
                });
            });
        };

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        const saveStory = async (storyText) => {
            if (!userId) {
                // Not authenticated, cannot save.
                return;
            }
            if (!storyText.trim()) {
                console.warn("Cannot save an empty story.");
                return;
            }
            
            // Get the current category
            const activeCategory = document.querySelector('.category-button.active').dataset.category;
            
            try {
                await addDoc(getStoriesCollectionRef(), {
                    text: storyText,
                    timestamp: serverTimestamp(),
                    userId: userId,
                    category: activeCategory
                });
                console.log("Story saved successfully!");
            } catch (error) {
                console.error("Error saving story:", error);
            }
        };

        const deleteStory = async (storyId) => {
            if (!userId) {
                console.warn("Not authenticated, cannot delete story.");
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/my-stories`, storyId));
                console.log("Story deleted successfully!");
            } catch (error) {
                console.error("Error deleting story:", error);
            }
        };
        
        // API Calls and UI Logic
        const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        const apiKey = "AIzaSyDfwJ1hjCRjIeZZClvhXnQKonrgwYJr5zc"; 

        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 401) {
                        throw new Error("Authentication Error: The API key is invalid or missing.");
                    }
                    if (!response.ok) {
                        throw new Error(`API call failed with status ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    console.log(`Retrying API call in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        async function fetchGeminiAPI(model, payload, useJSON = false) {
            const apiUrl = `${API_BASE_URL}${model}:generateContent?key=${apiKey}`;
            const headers = { 'Content-Type': 'application/json' };
            
            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content || !candidate.content.parts || candidate.content.parts.length === 0) {
                    throw new Error('API response is empty or malformed.');
                }
                
                const contentPart = candidate.content.parts[0];
                
                if (useJSON) {
                    const jsonString = contentPart.text;
                    if (!jsonString || jsonString.trim() === '') {
                        throw new Error('No JSON content found in the response.');
                    }
                    try {
                        return JSON.parse(jsonString);
                    } catch (e) {
                        throw new Error(`Failed to parse JSON: ${e.message}. Raw content: ${jsonString}`);
                    }
                } else {
                    const text = contentPart.text;
                    if (!text) {
                        throw new Error('No text content found in the response.');
                    }
                    return text;
                }
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        }
        
        async function generateCategoryIdeas(category) {
            const categoryPrompts = {
                general: "general creative stories",
                childrensStories: "engaging children's stories",
                poems: "beautiful and evocative poems",
                riddles: "clever and challenging riddles",
                jokes: "funny and light-hearted jokes",
                poetry: "deep and meaningful poetry"
            };

            const promptText = categoryPrompts[category] || "general creative stories";

            // Show loading state and clear old content
            suggestionOutput.innerHTML = `<div class="flex justify-center items-center p-4"><div class="category-spinner"></div></div>`;
            suggestionOutput.classList.remove('hidden');
            keywordsInput.value = ''; // Clear keywords
            promptOutput.innerHTML = `<p id="promptPlaceholder" class="text-gray-400 italic">Your story prompt will appear here...</p>`;
            storyOutput.innerHTML = `<p id="storyPlaceholder" class="text-gray-400 italic">Your complete story will appear here...</p>`;
            storyActions.classList.add('hidden');


            const prompt = `Generate 3 creative story ideas for ${promptText}. Respond only with a JSON array of objects. Each object should have a "title" and a "summary" key.`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING" },
                                "summary": { "type": "STRING" }
                            }
                        }
                    }
                }
            };
            
            try {
                const ideas = await fetchGeminiAPI('gemini-2.5-flash-preview-05-20', payload, true);
                suggestionOutput.innerHTML = ''; // Clear loading spinner
                ideas.forEach((idea, index) => {
                    const ideaDiv = document.createElement('div');
                    ideaDiv.className = `p-4 rounded-xl bg-gray-600 cursor-pointer hover:bg-gray-500 transition-colors suggestion-item`;
                    ideaDiv.style.animationDelay = `${index * 0.1}s`;
                    ideaDiv.innerHTML = `
                        <h4 class="font-bold text-gray-200">${idea.title}</h4>
                        <p class="text-sm text-gray-300 mt-1">${idea.summary}</p>
                    `;
                    ideaDiv.addEventListener('click', () => {
                        keywordsInput.value = idea.summary;
                        suggestionOutput.classList.add('hidden');
                        showPromptMessage('Idea copied to keywords. Now generate a prompt or story!', '#promptOutput');
                    });
                    suggestionOutput.appendChild(ideaDiv);
                });
            } catch (error) {
                suggestionOutput.innerHTML = `<p class="text-red-400 italic fade-in p-4">Error generating ideas: ${error.message}. Please try again.</p>`;
            }
        }

        async function suggestIdeas() {
            const keywords = keywordsInput.value.trim();
            if (!keywords) {
                showPromptMessage('Please enter some keywords first.', '#promptOutput');
                return;
            }

            setLoading(suggestIdeasBtn, true);
            suggestionOutput.innerHTML = '';
            suggestionOutput.classList.add('hidden');

            const storyLength = document.getElementById('storyLength').value;
            const storyAudience = document.getElementById('storyAudience').value;
            const storyFormat = document.getElementById('storyFormat').value;
            const storyGenre = document.getElementById('storyGenre').value;
            const storyLanguage = document.getElementById('storyLanguage').value;
            
            const prompt = `Generate 3 creative story ideas based on the following keywords: "${keywords}".
            The story ideas should be for a ${storyAudience} audience, in the ${storyFormat} format, and in the ${storyGenre} genre, and should be written in ${storyLanguage}.
            Respond only with a JSON array of objects. Each object should have a "title" and a "summary" key.`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING" },
                                "summary": { "type": "STRING" }
                            }
                        }
                    }
                }
            };
            
            try {
                const ideas = await fetchGeminiAPI('gemini-2.5-flash-preview-05-20', payload, true);
                suggestionOutput.classList.remove('hidden');
                ideas.forEach((idea, index) => {
                    const ideaDiv = document.createElement('div');
                    ideaDiv.className = `p-4 rounded-xl bg-gray-600 cursor-pointer hover:bg-gray-500 transition-colors suggestion-item`;
                    ideaDiv.style.animationDelay = `${index * 0.1}s`;
                    ideaDiv.innerHTML = `
                        <h4 class="font-bold text-gray-200">${idea.title}</h4>
                        <p class="text-sm text-gray-300 mt-1">${idea.summary}</p>
                    `;
                    ideaDiv.addEventListener('click', () => {
                        keywordsInput.value = idea.summary;
                        suggestionOutput.classList.add('hidden');
                        showPromptMessage('Summary copied to keywords. Now generate a prompt or story!', '#promptOutput');
                    });
                    suggestionOutput.appendChild(ideaDiv);
                });
            } catch (error) {
                showPromptMessage(`Error generating ideas: ${error.message}. Please try again.`, '#promptOutput');
            } finally {
                setLoading(suggestIdeasBtn, false);
            }
        }

        async function generatePrompt() {
            const keywords = keywordsInput.value.trim();
            if (!keywords) {
                showPromptMessage('Please enter some keywords first.', '#promptOutput');
                return;
            }

            setLoading(generatePromptBtn, true);
            const storyLength = document.getElementById('storyLength').value;
            const storyAudience = document.getElementById('storyAudience').value;
            const storyFormat = document.getElementById('storyFormat').value;
            const storyGenre = document.getElementById('storyGenre').value;
            const storyLanguage = document.getElementById('storyLanguage').value;
            
            const prompt = `Based on the keywords "${keywords}", generate a detailed, creative, and imaginative story prompt. The story should be ${storyLength} length, for a ${storyAudience} audience, in the ${storyFormat} format, and in the ${storyGenre} genre. The response must be written in ${storyLanguage}. The response should be a complete paragraph and should be ready to be used as a prompt for another AI.`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };
            
            try {
                const generatedPrompt = await fetchGeminiAPI('gemini-2.5-flash-preview-05-20', payload);
                promptOutput.innerHTML = `<p class="output-text fade-in">${generatedPrompt.replace(/\n/g, '<br>')}</p>`;
                promptOutput.classList.remove('hidden');
                currentStoryText = "";
                storyActions.classList.add('hidden');
            } catch (error) {
                showPromptMessage(`Error generating prompt: ${error.message}`, '#promptOutput');
            } finally {
                setLoading(generatePromptBtn, false);
            }
        }
        
        async function generateStory() {
            const promptText = promptOutput.innerText.trim();
            let sourceText = "";
            if(promptOutput.children[0].id === 'promptPlaceholder'){
                 showPromptMessage('Please generate a prompt first.', '#storyOutput');
                return;
            } else {
                 sourceText = promptText;
            }
            
            setLoading(generateStoryBtn, true);
            setStoryLoading(true);
            
            storyOutput.innerHTML = '';
            
            // Get the selected length and language
            const storyLengthKey = document.getElementById('storyLength').value;
            const wordCount = WORD_COUNTS[storyLengthKey];
            const storyLanguage = document.getElementById('storyLanguage').value;
            
            const storyGenerationPrompt = `Using the following text as a basis, write a story of approximately ${wordCount} words. The story must be in the ${storyLanguage} language. Text: "${sourceText}"`;

            const payload = {
                contents: [{ parts: [{ text: storyGenerationPrompt }] }],
            };
            
            try {
                const fullText = await fetchGeminiAPI('gemini-2.5-flash-preview-05-20', payload);
                
                // Set the full text at once for robustness
                storyOutput.innerHTML = `<p class="output-text">${fullText.replace(/\n/g, '<br>')}</p>`;
                currentStoryText = fullText;
                storyActions.classList.remove('hidden');
            } catch (error) {
                showPromptMessage(`Error writing story: ${error.message}`, '#storyOutput');
                storyActions.classList.add('hidden');
            } finally {
                setLoading(generateStoryBtn, false);
                setStoryLoading(false);
            }
        }

        async function refineStory() {
            if (!currentStoryText.trim()) {
                showPromptMessage('Please generate a story first.', '#storyOutput');
                return;
            }

            setLoading(refineStoryBtn, true);
            setStoryLoading(true);

            const storyLanguage = document.getElementById('storyLanguage').value;
            const prompt = `Refine the following text to have more descriptive language, a more engaging tone, and better flow. Do not add new plot points, only improve the existing text. The text is in ${storyLanguage}. Text to refine: "${currentStoryText}"`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            try {
                const refinedText = await fetchGeminiAPI('gemini-2.5-flash-preview-05-20', payload);
                storyOutput.innerHTML = `<p class="output-text fade-in">${refinedText.replace(/\n/g, '<br>')}</p>`;
                currentStoryText = refinedText;
            } catch (error) {
                showPromptMessage(`Error refining story: ${error.message}`, '#storyOutput');
            } finally {
                setLoading(refineStoryBtn, false);
                setStoryLoading(false);
            }
        }
        
        // General UI functions
        const showPromptMessage = (message, targetSelector) => {
            const target = document.querySelector(targetSelector);
            target.innerHTML = `<p class="text-red-400 italic fade-in">${message}</p>`;
            setTimeout(() => {
                target.innerHTML = `<p class="text-gray-400 italic fade-in">${targetSelector === '#promptOutput' ? 'Your story prompt will appear here...' : 'Your complete story will appear here...'}</p>`;
            }, 5000);
        };

        const setLoading = (button, isLoading) => {
            button.disabled = isLoading;
            button.innerHTML = isLoading ? `<svg class="loading-spinner w-5 h-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>` : button.dataset.originalText;
        };

        const setStoryLoading = (isLoading) => {
            if (isLoading) {
                storyPlaceholder.classList.add('hidden');
                storyLoadingOverlay.classList.remove('hidden');
            } else {
                storyLoadingOverlay.classList.add('hidden');
                if (storyOutput.innerText.trim() === '') {
                    storyPlaceholder.classList.remove('hidden');
                }
            }
        };

        // Page navigation logic
        const navigate = (hash) => {
            pages.forEach(page => page.classList.add('hidden'));
            const targetPage = document.querySelector(hash);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === hash) {
                    link.classList.add('active');
                }
            });
        };

        const handleHashChange = () => {
            const hash = window.location.hash || '#home-page';
            navigate(hash);
        };

        // TTS and Audio Conversion Functions
        const pcmToWav = (pcmData, sampleRate) => {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);

            let offset = 44;
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        };
        
        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const convertTextToAudio = async (textToConvert) => {
            if (!textToConvert.trim()) {
                throw new Error("No text to convert to audio.");
            }

            audioControlBtn.disabled = true;
            audioButtonText.textContent = "Converting...";
            downloadIcon.classList.add('hidden');
            audioLoadingSpinner.classList.remove('hidden');

            const payload = {
                contents: [{ parts: [{ text: textToConvert }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const apiUrl = `${API_BASE_URL}gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`TTS API call failed: ${response.status} - ${errorDetails}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (!audioData || !mimeType) {
                    throw new Error("No audio data received in the API response.");
                }

                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                if (!sampleRateMatch) {
                    throw new Error("Could not find sample rate in MIME type.");
                }
                const sampleRate = parseInt(sampleRateMatch[1], 10);
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                
                // Convert PCM to WAV
                const wavBlob = pcmToWav(pcm16, sampleRate);
                
                // Reset UI state
                audioControlBtn.disabled = false;
                audioButtonText.textContent = "Download Audio (MP3)";
                downloadIcon.classList.remove('hidden');
                audioLoadingSpinner.classList.add('hidden');

                return wavBlob;

            } catch (error) {
                audioControlBtn.disabled = false;
                audioButtonText.textContent = "Download Audio (MP3)";
                downloadIcon.classList.remove('hidden');
                audioLoadingSpinner.classList.add('hidden');
                throw error;
            }
        };

        const downloadAudio = (blob, filename) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
        
        // Event Listeners
        window.addEventListener('load', () => {
            initializeFirebase();
            handleHashChange();
            // Stagger the animation for category buttons
            document.querySelectorAll('.category-button').forEach((btn, index) => {
                btn.style.animationDelay = `${index * 0.05}s`;
            });
        });
        window.addEventListener('hashchange', handleHashChange);
        
        // Hide header on scroll down, show on scroll up
        window.addEventListener('scroll', () => {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (scrollTop > lastScrollTop && scrollTop > 100) {
                // Scrolling down
                header.classList.add('header-hidden');
            } else {
                // Scrolling up
                header.classList.remove('header-hidden');
            }
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
        }, false);
        
        // Save original button texts
        generatePromptBtn.dataset.originalText = generatePromptBtn.innerHTML;
        generateStoryBtn.dataset.originalText = generateStoryBtn.innerHTML;
        suggestIdeasBtn.dataset.originalText = suggestIdeasBtn.innerHTML;
        refineStoryBtn.dataset.originalText = refineStoryBtn.innerHTML;

        generatePromptBtn.addEventListener('click', generatePrompt);
        generateStoryBtn.addEventListener('click', generateStory);
        suggestIdeasBtn.addEventListener('click', suggestIdeas);
        saveStoryBtn.addEventListener('click', () => saveStory(currentStoryText));
        refineStoryBtn.addEventListener('click', refineStory);
        
        audioControlBtn.addEventListener('click', async () => {
            if (currentStoryText.trim()) {
                try {
                    const audioBlob = await convertTextToAudio(currentStoryText);
                    downloadAudio(audioBlob, `story_${Date.now()}.mp3`);
                } catch (error) {
                    showPromptMessage(`Failed to convert audio: ${error.message}`, '#storyOutput');
                }
            } else {
                showPromptMessage('Please generate a story first.', '#storyOutput');
            }
        });
        
        // Category button logic
        document.querySelectorAll('.category-button').forEach(btn => {
            btn.addEventListener('click', () => {
                // Do not proceed if already active
                if (btn.classList.contains('active')) return;
                
                document.querySelectorAll('.category-button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const category = btn.dataset.category;
                
                if (category === 'childrensStories') {
                    document.getElementById('storyAudience').value = 'children';
                    document.getElementById('storyFormat').value = 'short story';
                    document.getElementById('storyGenre').value = 'fantasy';
                } else if (category === 'poems') {
                    document.getElementById('storyAudience').value = 'general';
                    document.getElementById('storyFormat').value = 'poem';
                    document.getElementById('storyGenre').value = 'fantasy';
                } else if (category === 'riddles') {
                    document.getElementById('storyAudience').value = 'general';
                    document.getElementById('storyFormat').value = 'riddle';
                    document.getElementById('storyGenre').value = 'mystery';
                } else if (category === 'jokes') {
                    document.getElementById('storyAudience').value = 'general';
                    document.getElementById('storyFormat').value = 'joke';
                    document.getElementById('storyGenre').value = 'comedy';
                } else if (category === 'poetry') {
                    document.getElementById('storyAudience').value = 'general';
                    document.getElementById('storyFormat').value = 'poetry';
                    document.getElementById('storyGenre').value = 'fantasy';
                } else { // general
                    document.getElementById('storyAudience').value = 'general';
                    document.getElementById('storyFormat').value = 'prose';
                    document.getElementById('storyGenre').value = 'fantasy';
                }

                // Automatically generate ideas for the selected category
                generateCategoryIdeas(category);
            });
        });

        // User Auth forms
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.registerEmail.value;
            const password = e.target.registerPassword.value;
            const messageEl = document.getElementById('registerMessage');
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                messageEl.textContent = 'Registration successful! You can now log in.';
                messageEl.style.color = '#10b981';
            } catch (error) {
                messageEl.textContent = `Error: ${error.message}`;
                messageEl.style.color = '#ef4444';
                console.error("Registration error:", error);
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.loginEmail.value;
            const password = e.target.loginPassword.value;
            const messageEl = document.getElementById('loginMessage');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                messageEl.textContent = 'Login successful!';
                messageEl.style.color = '#10b981';
                window.location.hash = '#home-page';
            } catch (error) {
                messageEl.textContent = `Error: ${error.message}`;
                messageEl.style.color = '#ef4444';
                console.error("Login error:", error);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("User logged out.");
                window.location.hash = '#home-page';
            } catch (error) {
                console.error("Logout error:", error);
            }
        });
        
        // Copy to clipboard function
        const copyText = (text) => {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            console.log("Text copied to clipboard.");
        };

    </script>
</body>
</html>


